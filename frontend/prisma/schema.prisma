generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int         @id @default(autoincrement())
  email     String      @unique
  name      String?
  authId    String?     @unique
  avatar    String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @default(now()) @updatedAt
  role      Role        @default(PATIENT)
  city      String?
  latitude  Float?
  longitude Float?
  region    String?
  gender    Gender?
  age       Int?
  chats     Chat[]
  diagnoses Diagnosis[]
}

model Chat {
  id            Int             @id @default(autoincrement())
  chatId        String          @unique
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  userId        Int
  hasDiagnosis  Boolean         @default(false)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  diagnosis     Diagnosis?
  messages      Message[]
  tempDiagnoses TempDiagnosis[]
}

model Message {
  id            Int            @id @default(autoincrement())
  content       String
  role          MessageRole
  createdAt     DateTime       @default(now())
  chatId        String
  type          MessageType    @default(SYMPTOMS)
  chat          Chat           @relation(fields: [chatId], references: [chatId], onDelete: Cascade)
  tempDiagnosis TempDiagnosis?
  explanation   Explanation?
}

model TempDiagnosis {
  id          Int      @id @default(autoincrement())
  confidence  Float
  uncertainty Float
  disease     Disease
  createdAt   DateTime @default(now())
  messageId   Int      @unique
  modelUsed   Model
  chatId      String
  symptoms    String
  chat        Chat     @relation(fields: [chatId], references: [chatId], onDelete: Cascade)
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model Diagnosis {
  id          Int          @id @default(autoincrement())
  confidence  Float
  uncertainty Float
  disease     Disease
  createdAt   DateTime     @default(now())
  chatId      String       @unique
  userId      Int
  modelUsed   Model
  symptoms    String
  city        String?
  latitude    Float?
  longitude   Float?
  region      String?
  chat        Chat         @relation(fields: [chatId], references: [chatId], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  explanation Explanation?
}

model Explanation {
  id          Int        @id @default(autoincrement())
  createdAt   DateTime   @default(now())
  diagnosisId Int?       @unique
  messageId   Int?       @unique
  tokens      String[]
  importances Float[]
  diagnosis   Diagnosis? @relation(fields: [diagnosisId], references: [id], onDelete: Cascade)
  message     Message?   @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

enum Role {
  PATIENT
  CLINICIAN
  DEVELOPER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MessageRole {
  USER
  AI
}

enum MessageType {
  SYMPTOMS
  ANSWER
  QUESTION
  DIAGNOSIS
  URGENT_WARNING
  ERROR
}

enum Disease {
  DENGUE    @map("Dengue")
  PNEUMONIA @map("Pneumonia")
  TYPHOID   @map("Typhoid")
  IMPETIGO  @map("Impetigo")
}

enum Model {
  BIOCLINICAL_MODERNBERT @map("BioClinical-ModernBERT")
  ROBERTA_TAGALOG        @map("RoBERTa-Tagalog")
}
